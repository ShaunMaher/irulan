module.exports = wikipages;
module.exports.get = get;

var fs = require("fs");
var path = require("path");
var wikiContentDir = "";

function wikipages(global_settings, router) {
  wikiContentDir = global_settings['wiki content directory'];

  // Inject the client side scripts that will be included in the index.html
  //  "marked": Markdown to HTML renderer
  global_settings['client scripts']['single page application'].push({
    name: 'marked.min.js',
    offline_path: global_settings['node modules directory'] + '/marked/marked.min.js'
  })

  // Inject handlers for RESTful requests for page content
  router.get(/^\/pages\/wiki\//, function (req, res, next) {
    wikipages.get(req, res, next);
  })
  router.get(/^\/pages\/wiki:/, function (req, res, next) {
    wikipages.get(req, res, next);
  })
}

function get(req, res, next) {
  var context = [];
  context.req = req;
  context.res = res;
  context.next = next;

  context.pageName = path.basename(req._parsedUrl.path);
  context.fileName = wikiContentDir + context.pageName + ".md";
  fs.access(context.fileName, fs.R_OK, (function (err) {
    if (err) {
      console.log("Wiki page not found: '" + this.fileName + "'");
      this.next();
    }
    else {
      console.log("Sending wiki page from: '" + this.fileName + "'");
      context.wikipage = {
        name: context.pageName,
        sourceFormat: "md",
        content: ""
      };
      fs.readFile(context.fileName, 'utf8', (function(err, data) {
        if (err) {
          console.log("Error reading wiki page from: '" + context.fileName + "'")
          context.next();
          return;
        }
        context.wikipage.content = data;
        context.res.send(JSON.stringify(context.wikipage));
      }).bind(context));
    }
  }).bind(context));
}
