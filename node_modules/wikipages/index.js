module.exports = wikipages;
module.exports.get = get;

var fs = require("fs");
var path = require("path");
var wikiContentDir = "";

function wikipages(_wikiContentDir) {
  wikiContentDir = _wikiContentDir;
}

function get(req, res, next) {
  var context = [];
  context.req = req;
  context.res = res;
  context.next = next;

  context.pageName = path.basename(req._parsedUrl.path);
  context.fileName = wikiContentDir + context.pageName + ".md";
  fs.access(context.fileName, fs.R_OK, (function (err) {
    if (err) {
      console.log("Wiki page not found: '" + this.fileName + "'");
      this.next();
    }
    else {
      console.log("Sending wiki page from: '" + this.fileName + "'");
      context.wikipage = {
        name: context.pageName,
        sourceFormat: "md",
        content: ""
      };
      fs.readFile(context.fileName, 'utf8', (function(err, data) {
        if (err) {
          console.log("Error reading wiki page from: '" + context.fileName + "'")
          context.next();
          return;
        }
        context.wikipage.content = data;
        context.res.send(JSON.stringify(context.wikipage));
      }).bind(context));
    }
  }).bind(context));
}
